<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Nearby Workers - MistriG</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        #map {
            height: 70vh;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none; /* Initially hidden until location is granted */
        }
        .map-container {
            padding: 20px;
        }
        .worker-list {
            margin-top: 20px;
            display: none; /* Initially hidden until location is granted */
        }
        .worker-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }
        .worker-info {
            flex: 1;
        }
        .worker-distance {
            margin-left: 20px;
            font-weight: bold;
            color: #4c6ef5;
        }
        .location-message {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-weight: bold;
        }
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            display: none; /* Initially hidden until location is granted */
        }
        .filter-button {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            border-radius: 30px;
            background: white;
            cursor: pointer;
        }
        .filter-button.active {
            background: #4c6ef5;
            color: white;
            border-color: #4c6ef5;
        }
        /* Location permission dialog styles */
        .permission-dialog {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            padding: 25px;
            max-width: 500px;
            margin: 30px auto;
            text-align: center;
        }
        .permission-dialog h2 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .permission-dialog p {
            margin-bottom: 25px;
            color: #7f8c8d;
            line-height: 1.6;
        }
        .permission-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .btn-allow {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-allow:hover {
            background: #1d4ed8;
        }
        .btn-decline {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-decline:hover {
            background: #e5e7eb;
        }
        .permission-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 20px;
            background: #f0f9ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .permission-icon svg {
            width: 40px;
            height: 40px;
            color: #2563eb;
        }
        .manual-location-form {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            display: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .submit-location {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Radar animation styles */
        .radar-container {
            position: absolute;
            width: 300px;
            height: 300px;
            background-color: transparent;
            border-radius: 50%;
            display: none;
            overflow: visible;
            z-index: 999;
            pointer-events: none;
            transition: transform 0.2s ease-out;
            transform: translate(-50%, -50%); /* Center the container on its position point */
        }
        
        .map-wrapper {
            position: relative;
            width: 100%;
            height: 70vh;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .radar-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(37,99,235,0.2) 0%, rgba(37,99,235,0.1) 50%, transparent 70%);
        }
        
        .radar-spinner {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 150px;
            background: linear-gradient(to bottom, rgba(37,99,235,0.8), transparent);
            transform-origin: bottom center;
            animation: radarSpin 3s linear infinite;
        }
        
        .radar-rings {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .radar-ring {
            position: absolute;
            border: 1px solid rgba(37,99,235,0.3);
            border-radius: 50%;
        }
        
        .radar-ring:nth-child(1) {
            width: 50px;
            height: 50px;
            animation: pulse 2s infinite;
        }
        
        .radar-ring:nth-child(2) {
            width: 100px;
            height: 100px;
            animation: pulse 2s infinite 0.3s;
        }
        
        .radar-ring:nth-child(3) {
            width: 150px;
            height: 150px;
            animation: pulse 2s infinite 0.6s;
        }
        
        .radar-ring:nth-child(4) {
            width: 200px;
            height: 200px;
            animation: pulse 2s infinite 0.9s;
        }
        
        .radar-ring:nth-child(5) {
            width: 250px;
            height: 250px;
            animation: pulse 2s infinite 1.2s;
        }
        
        .user-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background-color: #2563eb;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .searching-text {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            text-align: center;
            color: #2563eb;
            font-weight: bold;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .radar-blips {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .radar-blip {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: #f59e0b;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            opacity: 0;
            box-shadow: 0 0 5px rgba(245, 158, 11, 0.5);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        @keyframes radarSpin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @keyframes blipAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0.7;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/">
                <img class="ic" src="/src/Images/mg.png" alt="MistriG">
                MistriG
            </a>
        </div>
        <button class="mobile-menu-btn">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/src/pages/find-work.html">Find Work</a>
            <a href="/src/pages/login.html" class="btn-primary">Join Now</a>
        </div>
    </nav>

    <main>
        <section class="page-header">
            <h1>Find Nearby Workers</h1>
            <p>Discover skilled workers in your area ready to help with your project</p>
        </section>

        <section class="map-container">
            <!-- Location Permission Dialog -->
            <div class="permission-dialog" id="permission-dialog">
                <div class="permission-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <h2>Location Access</h2>
                <p>To show you workers in your area, we need access to your location. This helps us find the nearest available professionals for your needs.</p>
                <div class="permission-buttons">
                    <button class="btn-allow" id="allow-location">Allow Access</button>
                    <button class="btn-decline" id="decline-location">No Thanks</button>
                </div>
                <p style="margin-top: 15px; font-size: 0.9em;">Your location data is only used to match you with nearby workers and is never shared with third parties.</p>
            </div>

            <!-- Manual Location Entry Form (shown if user declines automatic location) -->
            <div class="manual-location-form" id="manual-location-form">
                <h3>Enter Your Location</h3>
                <p>Please provide your city or area to find workers near you:</p>
                <div class="form-group">
                    <label for="city">City/Area</label>
                    <input type="text" id="city" placeholder="e.g., Delhi, Mumbai, Bangalore">
                </div>
                <button class="submit-location" id="submit-manual-location">Find Workers</button>
            </div>

            <div class="location-message" id="location-message" style="display: none;">
                Please allow location access to see nearby workers
            </div>
            
            <div class="filter-options" id="filter-options">
                <button class="filter-button active" data-service="all">All Services</button>
                <button class="filter-button" data-service="plumbing">Plumbing</button>
                <button class="filter-button" data-service="electrical">Electrical</button>
                <button class="filter-button" data-service="carpentry">Carpentry</button>
                <button class="filter-button" data-service="painting">Painting</button>
                <button class="filter-button" data-service="masonry">Masonry</button>
                <button class="filter-button" data-service="cleaning">Cleaning</button>
            </div>
            
            <div class="map-wrapper">
                <!-- Radar Animation Container - now positioned over the map -->
                <div class="radar-container" id="radar-container">
                    <div class="radar-animation"></div>
                    <div class="radar-spinner"></div>
                    <div class="radar-rings">
                        <div class="radar-ring"></div>
                        <div class="radar-ring"></div>
                        <div class="radar-ring"></div>
                        <div class="radar-ring"></div>
                        <div class="radar-ring"></div>
                    </div>
                    <div class="user-dot"></div>
                    <div class="radar-blips" id="radar-blips"></div>
                    <div class="searching-text">Searching for nearby workers...</div>
                </div>
                
                <div id="map"></div>
            </div>
            
            <div class="worker-list" id="worker-list">
                <!-- Worker cards will be populated here -->
            </div>
        </section>
    </main>

    <!-- Load Leaflet JS after the page is loaded -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script>
        // Simple navigation update function to handle authentication
        function updateNavigation() {
            const navLinks = document.querySelector('.nav-links');
            if (!navLinks) return;

            const joinButton = navLinks.querySelector('a[href="/src/pages/login.html"]');
            if (!joinButton) return;

            // Check if user is authenticated
            const isAuthenticated = localStorage.getItem('token') || localStorage.getItem('workerToken');
            
            if (isAuthenticated) {
                // User is logged in, replace Join Now button with user info
                const userType = localStorage.getItem('userType');
                const dashboardUrl = userType === 'worker' ? '/worker-dashboard.html' : '/dashboard.html';
                
                // Create a new user profile element
                const userProfileElement = document.createElement('a');
                userProfileElement.href = dashboardUrl;
                userProfileElement.className = 'user-profile-link';
                
                // Try to get user name from localStorage if available
                const userFirstName = localStorage.getItem('userFirstName');
                userProfileElement.textContent = userFirstName ? `Hello, ${userFirstName}` : 'My Profile';
                
                // Replace the join button with the user profile element
                joinButton.parentElement.replaceChild(userProfileElement, joinButton);
                
                // Add logout button if it doesn't exist
                if (!navLinks.querySelector('.logout-btn')) {
                    const logoutBtn = document.createElement('a');
                    logoutBtn.href = '#';
                    logoutBtn.className = 'logout-btn';
                    logoutBtn.textContent = 'Logout';
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        // Clear authentication data
                        localStorage.removeItem('token');
                        localStorage.removeItem('workerToken');
                        localStorage.removeItem('userType');
                        localStorage.removeItem('userFirstName');
                        // Redirect to home page
                        window.location.href = '/';
                    });
                    navLinks.appendChild(logoutBtn);
                }
            }
        }

        // Simple function to check if user is authenticated and redirect if not
        function requireAuth(type = 'any') {
            const clientToken = localStorage.getItem('token');
            const workerToken = localStorage.getItem('workerToken');
            const userType = localStorage.getItem('userType');
            
            if (!clientToken && !workerToken) {
                // Not authenticated, redirect to login
                window.location.href = '/src/pages/login.html';
                return false;
            }
            
            if (type === 'client' && !clientToken) {
                // Need client access but not authenticated as client
                window.location.href = '/src/pages/login.html';
                return false;
            }
            
            if (type === 'worker' && !workerToken) {
                // Need worker access but not authenticated as worker
                window.location.href = '/src/pages/worker-login.html';
                return false;
            }
            
            return true;
        }

        // Check if user is authenticated before allowing access to this page
        document.addEventListener('DOMContentLoaded', function() {
            // Update navigation to reflect logged-in status
            updateNavigation();
            
            if (!requireAuth('client')) {
                // If not authenticated as a client, the requireAuth function will redirect
                return;
            }
            
            // Initialize the map
            let map = null;
            let userMarker = null;
            let workersMarkers = [];
            let userLocation = null;
            
            // Sample worker data (in a real app, this would come from the API)
            const mockWorkers = [
                {
                    id: 1,
                    name: 'Rahul Kumar',
                    profession: 'Plumbing',
                    rating: 4.8,
                    location: { lat: 0, lng: 0 }, // Will be calculated relative to user
                    distance: 0, // Will be calculated
                    phone: '+91 9845678901'
                },
                {
                    id: 2,
                    name: 'Amit Singh',
                    profession: 'Electrical',
                    rating: 4.6,
                    location: { lat: 0, lng: 0 },
                    distance: 0,
                    phone: '+91 9876543210'
                },
                {
                    id: 3,
                    name: 'Priya Sharma',
                    profession: 'Painting',
                    rating: 4.9,
                    location: { lat: 0, lng: 0 },
                    distance: 0,
                    phone: '+91 8765432190'
                },
                {
                    id: 4,
                    name: 'Deepak Verma',
                    profession: 'Carpentry',
                    rating: 4.7,
                    location: { lat: 0, lng: 0 },
                    distance: 0,
                    phone: '+91 7654321098'
                },
                {
                    id: 5,
                    name: 'Sunil Patel',
                    profession: 'Masonry',
                    rating: 4.5,
                    location: { lat: 0, lng: 0 },
                    distance: 0,
                    phone: '+91 6543210987'
                }
            ];
            
            // Set up permission buttons
            const allowLocationBtn = document.getElementById('allow-location');
            const declineLocationBtn = document.getElementById('decline-location');
            const manualLocationForm = document.getElementById('manual-location-form');
            const submitManualLocationBtn = document.getElementById('submit-manual-location');
            const permissionDialog = document.getElementById('permission-dialog');
            const mapElement = document.getElementById('map');
            const workerListElement = document.getElementById('worker-list');
            const filterOptionsElement = document.getElementById('filter-options');
            const locationMessage = document.getElementById('location-message');
            
            // Check if location permission was previously granted
            checkLocationPermission();
            
            function checkLocationPermission() {
                // Check if we have stored coordinates in localStorage
                const storedLocation = localStorage.getItem('userLocation');
                const manualLocation = localStorage.getItem('manualLocation');
                
                if (storedLocation) {
                    // User has previously allowed location access
                    permissionDialog.style.display = 'none';
                    userLocation = JSON.parse(storedLocation);
                    
                    // Show radar animation
                    const radarContainer = document.getElementById('radar-container');
                    radarContainer.style.display = 'block';
                    
                    // Create random blips for the radar
                    createRadarBlips();
                    
                    // Show map and other elements
                    mapElement.style.display = 'block';
                    workerListElement.style.display = 'block';
                    filterOptionsElement.style.display = 'flex';
                    
                    initializeMap(userLocation);
                    populateWorkers(userLocation);
                    
                    // Continue generating radar blips
                    setInterval(createRadarBlips, 5000);
                } else if (manualLocation) {
                    // User has previously used manual location
                    permissionDialog.style.display = 'none';
                    userLocation = JSON.parse(manualLocation);
                    
                    // Show radar animation
                    const radarContainer = document.getElementById('radar-container');
                    radarContainer.style.display = 'block';
                    
                    // Create random blips for the radar
                    createRadarBlips();
                    
                    // Show map and other elements
                    mapElement.style.display = 'block';
                    workerListElement.style.display = 'block';
                    filterOptionsElement.style.display = 'flex';
                    
                    initializeMap(userLocation);
                    populateWorkers(userLocation);
                    
                    // Continue generating radar blips
                    setInterval(createRadarBlips, 5000);
                }
                // If no stored location, show the permission dialog (which is already visible by default)
            }
            
            allowLocationBtn.addEventListener('click', function() {
                permissionDialog.style.display = 'none';
                locationMessage.textContent = 'Accessing your location...';
                locationMessage.style.display = 'block';
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        // Success callback
                        function(position) {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            // Store location in localStorage for future visits
                            localStorage.setItem('userLocation', JSON.stringify(userLocation));
                            
                            locationMessage.style.display = 'none';
                            
                            // Show radar animation
                            const radarContainer = document.getElementById('radar-container');
                            radarContainer.style.display = 'block';
                            
                            // Create random blips for the radar
                            createRadarBlips();
                            
                            // Show map and other elements, but don't hide radar
                            mapElement.style.display = 'block';
                            workerListElement.style.display = 'block';
                            filterOptionsElement.style.display = 'flex';
                            
                            initializeMap(userLocation);
                            populateWorkers(userLocation);
                            
                            // Continue generating radar blips
                            setInterval(createRadarBlips, 5000);
                        },
                        // Error callback
                        function(error) {
                            console.error('Error getting location:', error);
                            let errorMessage = 'Unable to access your location.';
                            
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = 'Location access was denied. Please enter your location manually.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = 'Location information is unavailable. Please enter your location manually.';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = 'The request to get your location timed out. Please enter your location manually.';
                                    break;
                            }
                            
                            locationMessage.textContent = errorMessage;
                            manualLocationForm.style.display = 'block';
                        }
                    );
                } else {
                    locationMessage.textContent = 'Geolocation is not supported by your browser. Please enter your location manually.';
                    manualLocationForm.style.display = 'block';
                }
            });
            
            declineLocationBtn.addEventListener('click', function() {
                permissionDialog.style.display = 'none';
                manualLocationForm.style.display = 'block';
            });
            
            submitManualLocationBtn.addEventListener('click', function() {
                const city = document.getElementById('city').value;
                if (city) {
                    manualLocationForm.style.display = 'none';
                    // Use a geocoding service to convert the city to coordinates
                    // For demo purposes, we'll use a fixed location for Delhi
                    const delhiLocation = { lat: 28.6139, lng: 77.2090 };
                    userLocation = delhiLocation;
                    
                    // Store manual location in localStorage for future visits
                    localStorage.setItem('manualLocation', JSON.stringify(userLocation));
                    
                    // Show radar animation first
                    const radarContainer = document.getElementById('radar-container');
                    radarContainer.style.display = 'block';
                    
                    // Create random blips for the radar
                    createRadarBlips();
                    
                    // Show map and other elements
                    mapElement.style.display = 'block';
                    workerListElement.style.display = 'block';
                    filterOptionsElement.style.display = 'flex';
                    
                    initializeMap(userLocation);
                    populateWorkers(userLocation);
                    
                    // Continue generating radar blips
                    setInterval(createRadarBlips, 5000);
                } else {
                    alert('Please enter your city or area');
                }
            });
            
            // Add a reset location button in the map controls
            function addResetLocationButton() {
                // Create custom control
                const resetControl = L.Control.extend({
                    options: {
                        position: 'topright'
                    },
                    onAdd: function() {
                        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                        container.innerHTML = `
                            <a href="#" title="Reset Location Permission" style="display: block; width: 30px; height: 30px; line-height: 30px; text-align: center; background: white;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" style="margin: 6px;">
                                    <path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="#2563EB"/>
                                </svg>
                            </a>
                        `;
                        container.style.cursor = 'pointer';
                        container.onclick = function() {
                            // Clear stored location data
                            localStorage.removeItem('userLocation');
                            localStorage.removeItem('manualLocation');
                            
                            // Reload page to show permission dialog again
                            window.location.reload();
                        };
                        return container;
                    }
                });
                
                // Add the control to the map
                map.addControl(new resetControl());
            }
            
            function initializeMap(location) {
                // Create map centered at user location
                map = L.map('map').setView([location.lat, location.lng], 13);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                // Add user marker
                userMarker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: `<div style="background-color: #4c6ef5; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                userMarker.bindPopup('Your location').openPopup();
                
                // Add reset location button
                addResetLocationButton();
                
                // Setup continuous radar positioning
                setupRadarPositioning();
            }
            
            function positionRadarOverUser() {
                if (!map || !userMarker) return;
                
                const radarContainer = document.getElementById('radar-container');
                if (!radarContainer) return;
                
                // Get the pixel coordinates of the user marker on the map
                const userPoint = map.latLngToContainerPoint(userMarker.getLatLng());
                
                // Position the radar container over the user marker
                // Using left/top with transform: translate(-50%, -50%) to properly center
                radarContainer.style.left = userPoint.x + 'px';
                radarContainer.style.top = userPoint.y + 'px';
            }
            
            // Keep radar centered on user when map is panned or zoomed
            function setupRadarPositioning() {
                if (!map) return;
                
                // Continuous positioning to ensure smoothness
                function updateRadarPosition() {
                    positionRadarOverUser();
                    requestAnimationFrame(updateRadarPosition);
                }
                
                // Start continuous updates
                updateRadarPosition();
                
                // Also update on specific map events for redundancy
                map.on('move', positionRadarOverUser);
                map.on('zoom', positionRadarOverUser);
                map.on('viewreset', positionRadarOverUser);
                map.on('resize', positionRadarOverUser);
            }
            
            function populateWorkers(userLoc) {
                // Clear any existing markers
                if (workersMarkers.length > 0) {
                    workersMarkers.forEach(marker => map.removeLayer(marker));
                    workersMarkers = [];
                }
                
                // Calculate mock locations and distances for workers
                mockWorkers.forEach(worker => {
                    // Generate a random position within ~5km of the user
                    const randomLat = userLoc.lat + (Math.random() - 0.5) * 0.05;
                    const randomLng = userLoc.lng + (Math.random() - 0.5) * 0.05;
                    
                    worker.location = { lat: randomLat, lng: randomLng };
                    
                    // Calculate rough distance (not accurate but enough for demo)
                    const distance = Math.sqrt(
                        Math.pow((userLoc.lat - randomLat) * 111, 2) + 
                        Math.pow((userLoc.lng - randomLng) * 111 * Math.cos(userLoc.lat * Math.PI/180), 2)
                    );
                    
                    worker.distance = distance.toFixed(1);
                    
                    // Add worker marker to map
                    const workerMarker = L.marker([randomLat, randomLng], {
                        icon: L.divIcon({
                            className: 'worker-marker',
                            html: `<div style="background-color: #f59e0b; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);
                    
                    workerMarker.bindPopup(`
                        <strong>${worker.name}</strong><br>
                        ${worker.profession}<br>
                        Rating: ${worker.rating}/5<br>
                        Distance: ${worker.distance} km<br>
                        <a href="tel:${worker.phone}" style="color: #4c6ef5;">Call Now</a>
                    `);
                    
                    workersMarkers.push(workerMarker);
                });
                
                // Sort workers by distance
                mockWorkers.sort((a, b) => a.distance - b.distance);
                
                // Populate worker list
                const workerList = document.getElementById('worker-list');
                workerList.innerHTML = '';
                
                mockWorkers.forEach(worker => {
                    const workerCard = document.createElement('div');
                    workerCard.className = 'worker-card';
                    workerCard.dataset.profession = worker.profession.toLowerCase();
                    
                    workerCard.innerHTML = `
                        <div class="worker-info">
                            <h3>${worker.name}</h3>
                            <p>${worker.profession} • Rating: ${worker.rating}/5</p>
                            <a href="tel:${worker.phone}" class="call-btn">Call Now</a>
                        </div>
                        <div class="worker-distance">${worker.distance} km</div>
                    `;
                    
                    workerCard.addEventListener('click', function() {
                        // Center map on the worker's location
                        map.setView([worker.location.lat, worker.location.lng], 14);
                        
                        // Find and open the worker's popup
                        workersMarkers.forEach(marker => {
                            if (marker.getLatLng().lat === worker.location.lat && 
                                marker.getLatLng().lng === worker.location.lng) {
                                marker.openPopup();
                            }
                        });
                    });
                    
                    workerList.appendChild(workerCard);
                });
                
                // Set up filter buttons
                const filterButtons = document.querySelectorAll('.filter-button');
                filterButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // Update active button
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        
                        const serviceFilter = this.dataset.service;
                        
                        // Filter worker cards
                        const workerCards = document.querySelectorAll('.worker-card');
                        workerCards.forEach(card => {
                            if (serviceFilter === 'all' || card.dataset.profession === serviceFilter) {
                                card.style.display = 'flex';
                            } else {
                                card.style.display = 'none';
                            }
                        });
                        
                        // Filter map markers
                        workersMarkers.forEach((marker, index) => {
                            const workerProfession = mockWorkers[index].profession.toLowerCase();
                            if (serviceFilter === 'all' || workerProfession === serviceFilter) {
                                marker.addTo(map);
                            } else {
                                map.removeLayer(marker);
                            }
                        });
                    });
                });
            }
            
            // Function to create random blips for the radar animation
            function createRadarBlips() {
                const blipsContainer = document.getElementById('radar-blips');
                if (!blipsContainer) return;
                
                blipsContainer.innerHTML = '';
                
                // Create 5-8 random blips
                const numBlips = 5 + Math.floor(Math.random() * 4);
                
                // Profile pictures for workers
                const profilePics = [
                    '/src/Images/worker1.jpg',
                    '/src/Images/worker2.jpg',
                    '/src/Images/worker3.jpg',
                    '/src/Images/worker4.jpg',
                    '/src/Images/worker5.jpg',
                    // Fallback profile images in case actual worker images don't exist
                    'https://randomuser.me/api/portraits/men/1.jpg',
                    'https://randomuser.me/api/portraits/women/2.jpg',
                    'https://randomuser.me/api/portraits/men/3.jpg',
                    'https://randomuser.me/api/portraits/women/4.jpg',
                    'https://randomuser.me/api/portraits/men/5.jpg'
                ];
                
                for (let i = 0; i < numBlips; i++) {
                    // Random position within the radar (in polar coordinates)
                    const distance = 30 + Math.random() * 100; // Distance from center (30-130px)
                    const angle = Math.random() * Math.PI * 2; // Random angle
                    
                    // Convert to cartesian coordinates (in px within the radar container)
                    const x = 150 + Math.cos(angle) * distance; // 150px is half of container width
                    const y = 150 + Math.sin(angle) * distance; // 150px is half of container height
                    
                    // Create the blip element
                    const blip = document.createElement('div');
                    blip.className = 'radar-blip';
                    blip.style.left = x + 'px';
                    blip.style.top = y + 'px';
                    
                    // Set a random profile picture as background
                    const randomPicIndex = Math.floor(Math.random() * profilePics.length);
                    blip.style.backgroundImage = `url('${profilePics[randomPicIndex]}')`;
                    
                    // Add a delay before the blip appears
                    const delay = 500 + Math.random() * 2000; // 0.5-2.5 seconds delay
                    setTimeout(() => {
                        blip.style.animation = 'blipAppear 0.5s forwards';
                        
                        // Remove blip after some time
                        setTimeout(() => {
                            if (blip.parentNode === blipsContainer) {
                                blipsContainer.removeChild(blip);
                            }
                        }, 3000 + Math.random() * 2000); // 3-5 seconds lifetime
                    }, delay);
                    
                    blipsContainer.appendChild(blip);
                }
            }
        });
    </script>
</body>
</html> 